var{CatchableError:h,lodash:i,fse:I,rimraf:K,getCredential:$,spinner:x,Logger:D}=require("@serverless-devs/core"),j=new D("cdn-fc-plugin"),{ListCustomDomainsRequest:S}=require("@alicloud/fc-open20210406"),T=require("@alicloud/fc-open20210406").default,_=require("@alicloud/openapi-client").Config;module.exports=async function(c,C){let d=x("cdn-fc-plugin start"),{serviceName:a,functionName:m,region:E}=C;if(d.start("cdn-fc-plugin working!"),i.isEmpty(a))throw new h("plugin cdn-fc-plugin's args : serviceName is required!");if(i.isEmpty(m))throw new h("plugin cdn-fc-plugin's args : serviceName is required!");let o=c.credentials;i.isEmpty(o)&&(c.credentials=await $(c.project.access),o=c.credentials);let y=new _({accessKeyId:o.AccessKeyID,accessKeySecret:o.AccessKeySecret,securityToken:o.SecurityToken});y.endpoint=`${o.AccountID}.${E}.fc.aliyuncs.com`;let k=new T(y),N=new S({limit:8}),e=[],f="";do{N.nextToken=f;let{customDomains:n,nextToken:l}=(await k.listCustomDomains(N)).body;if(f=l,i.isEmpty(n))break;n.forEach(t=>{let u=t.routeConfig;if(!i.isEmpty(u)&&!i.isEmpty(u.routes)){let s=u.routes,w=!1;for(let p=0;p<s.length;p++){let g=s[p],q=g.serviceName,v=g.functionName;if(q==a){if(v==m&&g.path=="/*"){e.push({path:"/*",domainName:t.domainName});break}}else w=!0}w||e.push({path:"other",domainName:t.domainName})}})}while(f);if(e.length<=0)throw new h(`cannot find the service<${a}> function <${m}> 's domainName `);let r=[];if(e.length==1){let n=e[0];r.push({type:"fc_domain",content:n.domainName,priority:20,weight:100})}else{let n=100,l=100;r=e.map((t,u)=>{if(t.path=="/*"){let s=n==10?10:n--;r.push({type:"fc_domain",content:t.domainName,priority:20,weight:s})}else{let s=l==10?10:l--;r.push({type:"fc_domain",content:t.domainName,priority:30,weight:s})}})}return d.info(`get service<${a}> function <${m}> 's domainNames<${e.join(",")}> successed!`),d.stop(),i.merge(c,{props:{sources:r}})};
